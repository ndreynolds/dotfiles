" .vimrc
" Author:     Nick Reynolds <ndreynolds@gmail.com>
" Repository: http://github.com/ndreynolds/dotfiles


" Plugins ------------------------------------------------------- {{{

set shell=/bin/sh
set nocompatible

if !filereadable($HOME . '/.vim/autoload/plug.vim')
  silent !curl -fLo ~/.vim/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
endif

call plug#begin('~/.vim/plugged')

" Language Support ---------------------------------------------

Plug 'dag/vim-fish'
Plug 'digitaltoad/vim-jade'
Plug 'ecomba/vim-ruby-refactoring'
Plug 'fatih/vim-go'
Plug 'groenewege/vim-less'
Plug 'jcf/vim-latex'
Plug 'kchmck/vim-coffee-script'
" Plug 'lukaszb/vim-web-indent'
" Plug 'pangloss/vim-javascript'
" Plug 'mxw/vim-jsx'
" Plug 'othree/xml.vim'
" Plug 'pbrisbin/vim-syntax-shakespeare'
Plug 'slim-template/vim-slim'
Plug 'tpope/vim-haml'
Plug 'tpope/vim-markdown'
" Plug 'wavded/vim-stylus'
" Plug 'chrisbra/csv.vim'
Plug 'eagletmt/neco-ghc'
" Plug 'vim-pandoc/vim-pandoc'
" Plug 'vim-pandoc/vim-pandoc-syntax'
Plug 'vim-ruby/vim-ruby'
Plug 'wting/rust.vim'
Plug 'metakirby5/codi.vim'

" Colorschemes / Visual ----------------------------------------

" Plug 'altercation/vim-colors-solarized'
" Plug 'junegunn/seoul256.vim'
Plug 'tyrannicaltoucan/vim-quantum'
Plug 'bling/vim-airline'

" Motions / Text Objects / Mappings ----------------------------

" Plug 'bkad/CamelCaseMotion'
" Plug 'godlygeek/tabular'
Plug 'nelstrom/vim-textobj-rubyblock'
Plug 'lokaltog/vim-easymotion'
Plug 'kana/vim-textobj-user'
Plug 'tpope/vim-abolish'
Plug 'tpope/vim-commentary'
Plug 'tpope/vim-endwise'
Plug 'tpope/vim-surround'

" Utilities ----------------------------------------------------

Plug 'bogado/file-line'
Plug 'honza/vim-snippets'
Plug 'itchyny/calendar.vim'
Plug 'junegunn/fzf', { 'dir': '~/.fzf', 'do': './install --all' }
Plug 'junegunn/fzf.vim'
" Plug 'neomake/neomake'
Plug 'majutsushi/tagbar'
" Plug 'scrooloose/syntastic'
" Plug 'w0rp/ale'
Plug 'sjl/gundo.vim'
Plug 'tpope/vim-dispatch'
Plug 'radenling/vim-dispatch-neovim'
Plug 'tpope/vim-eunuch'
Plug 'tpope/vim-fugitive'
Plug 'tpope/vim-rails'
" Plug 'tpope/vim-rhubarb'
Plug 'tpope/vim-rsi'
Plug 'tpope/vim-vinegar'
" Plug 'vim-scripts/LanguageTool'
Plug 'vim-scripts/renamer.vim'
Plug 'christoomey/vim-tmux-navigator'

call plug#end()

" }}}


" Options ------------------------------------------------------- {{{

syntax on
set number
set tabstop=4
set expandtab
set shiftwidth=4

set encoding=utf-8
set scrolloff=3
set autoindent
set showmode
set showcmd
set hidden
set wildmenu
set wildmode=longest:full,full

set wildignore+=.git,.svn,.hg,.pyc,.sw?
set cursorline
set ttyfast
set ruler
set backspace=indent,eol,start
set laststatus=2
set mouse=a
set iskeyword+=\-

set ignorecase
set smartcase
set incsearch
set showmatch
set hlsearch
set foldmethod=marker

" Store swap, backup and undo files within .vim/
" Make the directories as needed.

if !isdirectory($HOME . '/.vim/swap')
  :silent !mkdir -p ~/.vim/swap > /dev/null 2>&1
endif
set dir=~/.vim/swap

if !isdirectory($HOME . '/.vim/backup')
  :silent !mkdir -p ~/.vim/backup > /dev/null 2>&1
endif
set backupdir=~/.vim/backup
set backup

if exists("+undofile")
  if !isdirectory($HOME . '/.vim/undo')
    :silent !mkdir -p ~/.vim/undo > /dev/null 2>&1
  endif
  set undodir=~/.vim/undo
  set undofile
endif

" }}}


" Plugin Configuration ------------------------------------------- {{{

" LanguageTool
let jar = '/usr/local/Cellar/languagetool/2.3/libexec/languagetool-commandline.jar'
if filereadable(jar)
  let g:languagetool_jar = jar
endif
let g:languagetool_disable_rules = 'WHITESPACE_RULE,EN_QUOTES,TYPOGRAFISCHE_ANFUEHRUNGSZEICHEN'

" airline
if $POWERLINE_FANCY
  let g:airline_powerline_fonts=1
endif

" colorscheme
if has('termguicolors')
  set termguicolors
endif
let g:airline_theme='quantum'
set background=dark
colorscheme quantum

" rsi
let g:rsi_no_meta = 1

" fzf
let g:fzf_files_options = '--preview "ccat --color=always {}"'


" }}}


" Mappings ------------------------------------------------------- {{{

" Set leader to ,
let mapleader = ","
let maplocalleader = ","

" Make Y behave like C & D
nnoremap Y y$

" Shortcut for the directory of the current file
cnoremap %/ <c-r>=expand('%:p:h')<CR>/

" Clear search highlighting
nnoremap <silent> <c-l> :nohl<CR><c-l>

" CTRL-{j,k,l,h} to switch windows
nnoremap <c-j> <c-w>j
nnoremap <c-k> <c-w>k
nnoremap <c-l> <c-w>l
nnoremap <c-h> <c-w>h
if has('nvim')
  nnoremap <bs> <c-w>h
endif

" Catch accidental shift keys
command! -bang -nargs=* -complete=file E e<bang> <args>
command! -bang -nargs=* -complete=file W w<bang> <args>
command! -bang -nargs=* -complete=file Wq wq<bang> <args>
command! -bang -nargs=* -complete=file Wqa wqa<bang> <args>
command! -bang -nargs=* -complete=file WQ wq<bang> <args>
command! -bang -nargs=* -complete=file Q q<bang> <args>
command! -bang -nargs=* -complete=file Vsp vsp<bang> <args>

" vim-rails shortcuts
nnoremap <leader>rv :Rview<cr>
nnoremap <leader>rc :Rcontroller<cr>
nnoremap <leader>rm :Rmodel<cr>

" fugitive shortcuts
nnoremap <leader>gd :Gdiff<cr>
nnoremap <leader>gs :Gstatus<cr>
nnoremap <leader>ga :Gadd<cr>

" EasyMotion
let g:EasyMotion_leader_key = '<leader><space>'

" Reflow text to 80 cols
nnoremap <leader>sw :set textwidth=80<cr>:normal! gggqG<esc>

" Write file with 'eventignore' set.
cnoremap w-- noautocmd w

" Edit vimrc
nnoremap <leader>ev :e $MYVIMRC<cr>

" Source vimrc
nnoremap <leader>sv :source $MYVIMRC<cr>

" FZF
nnoremap <leader><leader> :Files<cr>
nnoremap <leader>n :FZF ~/repos/notes<cr>
nnoremap <leader>t :Tags<cr>

" Pretty print JSON and XML
nnoremap <leader>j :%!python -m json.tool<cr>
vnoremap <leader>j :!python -m json.tool<cr>
nnoremap <leader>x :%!tidy -i -q -asxhtml -utf8<cr>
vnoremap <leader>x :!tidy -i -q -xml -utf8<cr>

" Underline a heading
nnoremap <leader>u yyp<c-v>$r-

" * and # in visual mode search for the selection (from Practical Vim)
xnoremap * :<c-u>call <sid>VSetSearch()<cr>/<c-r>=@/<cr><cr>
xnoremap # :<c-u>call <sid>VSetSearch()<cr>?<c-r>=@/<cr><cr>

" Rspec with Dispatch
nnoremap <leader>r :Dispatch rspec %<cr>

" bind K to grep word under cursor
nnoremap K :grep! "\b<C-R><C-W>\b"<CR>:cw<CR>

" <ctrl-c> to redraw screen
nnoremap <c-c> :redraw!<cr>

" }}}


" Statusline ----------------------------------------------------- {{{

set statusline=[%n]\ %<%.99f\ %h%w%m%r%{fugitive#statusline()}%{exists('*CapsLockStatusline')?CapsLockStatusline():''}%y%=%-16(\ %l,%c-%v\ %)%P

" }}}


" Misc ----------------------------------------------------------- {{{

" Highlight lines longer than 80 chars
highlight OverLength ctermbg=red ctermfg=white guibg=#592929
match OverLength /\%81v.\+/

" VCS conflict markers
match ErrorMsg '^\(<\|=\|>\)\{7\}\([^=].\+\)\?$'

" }}}


" Abbreviations -------------------------------------------------- {{{

iabbrev @@ ndreynolds@gmail.com
iabbrev ndr Nick Reynolds
iabbrev <expr> dts strftime("%c")
iabbrev <expr> sig 'Nick Reynolds (' . strftime("%c") . ')'

" }}}


" Event Autocommands --------------------------------------------- {{{

" Resize splits on window resize
au VimResized * :wincmd =

au BufNewFile,BufRead *.txt set filetype=markdown
au BufNewFile,BufRead *.json set filetype=javascript
au BufNewFile,BufRead *.h set filetype=c

au QuickFixCmdPost *grep* cwindow

au BufWritePre * :%s/\s\+$//e

" }}}


" FileType Autocommands ------------------------------------------ {{{

augroup FTOptions
  au Filetype python                   setlocal ai et sta sw=4 sts=4 tw=79
  au Filetype cpp,cs,java              setlocal ai et sta sw=4 sts=4 cin

  au Filetype c,ruby,coffee,jsx,css,scss,less,eruby,haml,html,xhtml,eruby,yaml,json,vim,markdown,sh,bash,zsh
    \ setlocal ai et sta sw=2 sts=2

  au FileType gitcommit,markdown,ruby,haml
    \ setlocal spell

  au FileType haskell                  setlocal omnifunc=necoghc#omnifunc
  au FileType crontab                  set nobackup nowritebackup
  au FileType help                     nnoremap <silent><buffer> q :q<cr>

  au FileType ruby,eruby
                    \ set omnifunc=rubycomplete#Complete       |
                    \ let g:rubycomplete_buffer_loading = 1    |
                    \ let g:rubycomplete_classes_in_global = 1 |
                    \ let g:rubycomplete_rails = 1
augroup END

" }}}
